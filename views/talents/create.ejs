<%- include('../partials/header') %>

<style>
  .form-group {
    margin-top: 1rem;
  }
</style>

<div id="alerts-container" style='margin-top: 1rem;'>

</div>

<h1 style='margin-top: 1rem;'>Submit a Talent</h1>

<form id="create-talent-form">
  <div class="input-group mb-3">
    <div class="input-group-prepend">
      <span class="input-group-text">Upload Talent Image</span>
    </div>
    <div class="custom-file">
      <input name="profile_picture" type="file" class="custom-file-input" id="talent-profile-picture">
      <label id='talent-profile-picture-label' class="custom-file-label" for="talent-profile-picture">Choose jpg, jpeg, or png</label>
    </div>
  </div>

  <div class="form-group">
    <label for="talent-name">Talent Name</label>
    <input type="text" class="form-control" id="talent-name" name="name" placeholder="Enter talent name">
  </div>
  <div class="form-group">
    <label for="talent-description">Description</label>
    <textarea name="description" class="form-control" id="talent-description" rows="3" placeholder="Describe the talent! What does he/she/they do? What are their hobbies?"></textarea>
  </div>
  <div style='margin-top: 1rem;'>
    <button id="submit-button" type="submit" class="btn btn-primary" style='display: inline;'>Submit</button>
    <div class="spinner-border" role="status" id="spinner">
  </div>
  </div>
</form>

<script>
  const talentRepository = new TalentRepository();

  $("#spinner").hide();

  $("#create-talent-form").submit(function (e) {
    e.preventDefault();

    Promise.resolve()
      .then(() => setLoadingState())
      .then(() => talentRepository.insert(new FormData(document.getElementById('create-talent-form'))))
      .then(() => redirectToHomePage())
      .catch(handleError);

  });

  $('#talent-profile-picture').on('change',function(){
    //get the file name
    var fileName = $(this).val().replace('C:\\fakepath\\', " ");
    //replace the "Choose a file" label
    $(this).next('#talent-profile-picture-label').html(fileName);
  })

  function setLoadingState() {
    $("#spinner").show()
    $("#submit-button").prop('disabled', true);
  }

  function handleError(e) {
    $("#spinner").hide()
    $("#submit-button").prop('disabled', false);

    const messages = [];

    if (e.responseJSON && e.responseJSON.message) {
      messages.push(e.responseJSON.message);
    }

    // validation errors
    if (e.responseJSON && e.responseJSON.errors) {
      for (let error of errors) {
        messages.push(error);
      }
    }

    if (messages.length === 0) {
      let message = "Something went wrong."

      if (e.status) {
        message = `Network request failed with status ${e.status}`
      }

      messages.push(message);
    }

    $("#alerts-container").empty();
    $("#alerts-container").append(
      messages.map(m => `
        <div class="alert alert-danger" role="alert">
          ${m}
        </div>
      `)
    );
  }
  
  function isImage() {
      var fileName = document.getElementById('receipt').value;
      var idxDot = fileName.lastIndexOf(".") + 1;
      var extFile = fileName.substr(idxDot, fileName.length).toLowerCase();
      return extFile == "jpg" || extFile == "jpeg" || extFile == "png";
  }

  function redirectToHomePage() {
    window.location.replace('/');
  }



</script>

<%- include('../partials/footer') %>